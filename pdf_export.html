<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Экспорт КП UIS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Manrope:wght@500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: #eee; }
        :root { --color-primary: #0000aa; }
        
        #print-area {
            width: 794px; /* A4 width */
            min-height: 1123px; /* A4 height */
            background: white;
            margin: 0 auto;
            padding: 40px;
            box-sizing: border-box;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .print-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid var(--color-primary); padding-bottom: 20px; }
        .print-logo { font-family: 'Manrope', sans-serif; font-weight: 800; font-size: 32px; color: var(--color-primary); }
        .print-title { font-size: 18px; font-weight: 700; text-transform: uppercase; color: #333; }
        
        .print-manager { margin-bottom: 30px; padding: 15px; background: #F8F9FC; border-radius: 12px; border: 1px solid #eee; }
        .print-manager h3 { margin: 0 0 10px 0; font-size: 14px; color: var(--color-primary); text-transform: uppercase; }
        .print-manager p { margin: 4px 0; font-size: 14px; color: #333; }

        .print-section { 
            margin-bottom: 20px; 
            page-break-inside: auto; 
            break-inside: auto;
            border: 1px solid #e0e0e0;
            border-radius: 16px;
            padding: 15px 20px;
        }

        .print-table { width: 100%; border-collapse: collapse; }
        .print-table td { padding: 10px 5px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
        .print-table tr { page-break-inside: avoid; break-inside: avoid; }
        .print-table tr:last-child td { border-bottom: none; }
        
        .print-row-name { font-weight: 700; font-size: 14px; color: #000; margin-bottom: 2px; }
        .print-row-desc { font-size: 10px; color: #777; line-height: 1.3; white-space: pre-wrap; margin-top: 4px; }
        .print-row-value { font-weight: 600; font-size: 13px; text-align: right; white-space: nowrap; }
        
        .price-badge {
            display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 6px; 
            font-weight: 600; font-size: 11px; white-space: nowrap; line-height: 1.4;
            background: #E6F0FF; color: var(--color-primary); margin-bottom: 2px;
        }

        .print-totals { 
            background: #F0F2F5; 
            border-radius: 16px; 
            padding: 25px; 
            margin-top: 30px; 
            margin-bottom: 30px;
            page-break-inside: avoid; 
            break-inside: avoid;
        }
        .print-total-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 13px; }
        .print-total-row.main { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ccc; align-items: center; }
        .print-total-row.main .label { font-size: 18px; font-weight: 800; color: var(--color-primary); text-transform: uppercase; }
        .print-total-row.main .value { font-size: 28px; font-weight: 800; color: var(--color-primary); }
        .print-total-helper { display: block; font-size: 9px; color: #777; margin-top: 2px; line-height: 1.4; max-width: 300px; white-space: pre-wrap; }

        .print-social { 
            margin-top: auto; 
            padding-top: 20px; 
            border-top: 2px solid #eee; 
            page-break-inside: avoid; 
            break-inside: avoid;
        }
        .print-social-list { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 12px; 
        }
        .print-social-link { 
            font-size: 11px; 
            color: #777; 
            text-decoration: none; 
            display: flex; 
            align-items: center;
            justify-content: center;
            background: #fcfcfc;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .print-social-link span { font-weight: 700; color: #666; margin-right: 0; }

        .loader {
            position: fixed; top:0; left:0; width:100%; height:100%; background: white; z-index: 10000;
            display: flex; justify-content: center; align-items: center; font-size: 20px; font-weight: 700; color: #333;
            flex-direction: column; gap: 10px;
        }
    </style>
</head>
<body>

<div id="loader" class="loader">
    <div>Формирование PDF...</div>
    <div style="font-size: 14px; font-weight: normal; color: #666;">Пожалуйста, подождите</div>
</div>

<div id="print-area">
    <div class="print-header">
        <div class="print-logo">UIS</div>
        <div class="print-title">Коммерческое предложение</div>
    </div>
    
    <div id="print-manager-block" class="print-manager" style="display:none;">
        <h3>Ваш персональный менеджер:</h3>
        <p id="print-mgr-name"></p>
        <p id="print-mgr-phone"></p>
        <p id="print-mgr-email"></p>
    </div>

    <div id="sections-container"></div>

    <div class="print-totals">
        <div class="print-total-row main">
            <span class="label">Ежемесячный платёж</span>
            <span class="value" id="t-monthly"></span>
        </div>
        <div class="print-total-row" id="row-minimal">
            <div>
                <span>Минимальный счет на связь</span>
                <span class="print-total-helper" id="t-minimal-desc"></span>
            </div>
            <span id="t-minimal"></span>
        </div>
        <div class="print-total-row" id="row-connection">
            <div>
                <span>Подключение номеров</span>
                <span class="print-total-helper" id="t-connection-desc"></span>
            </div>
            <span id="t-connection"></span>
        </div>
        <div class="print-total-row" id="row-delivery">
            <div>
                <span>Доставка FMC-сим карт</span>
                <span class="print-total-helper" id="t-delivery-desc"></span>
            </div>
            <span id="t-delivery"></span>
        </div>
        <div class="print-total-row" style="margin-top:15px; padding-top:15px; border-top:1px solid #ddd;" id="row-guarantee">
            <div>
                <span>Гарантийный взнос</span>
                <span class="print-total-helper" id="t-guarantee-desc"></span>
            </div>
            <span id="t-guarantee" style="font-weight:700"></span>
        </div>
    </div>

    <div class="print-social">
        <div class="print-social-list">
            <a href="https://t.me/uis_technology" class="print-social-link"><span>Оперативная информация</span></a>
            <a href="https://t.me/uiscom_ru" class="print-social-link"><span>UIS говорит</span></a>
            <a href="https://vk.com/uiscom" class="print-social-link"><span>ВКонтакте</span></a>
            <a href="https://vc.ru/uiscom" class="print-social-link"><span>Блог на VC.ru</span></a>
            <a href="https://rutube.ru/channel/24800224/" class="print-social-link"><span>RUTUBE</span></a>
            <a href="https://dzen.ru/id/5d4a870ef2df2500ae39c4ad?share_to=link" class="print-social-link"><span>Дзен</span></a>
        </div>
    </div>
</div>

<script>
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const payload = urlParams.get('payload');

        if (!payload) {
            document.getElementById('loader').innerText = "Ошибка: Нет данных";
            return;
        }

        try {
            // Robust Base64 Decoding for UTF-8
            const json = decodeURIComponent(escape(window.atob(payload)));
            const data = JSON.parse(json);

            // 1. Manager
            if (data.manager.name || data.manager.phone || data.manager.email) {
                document.getElementById('print-manager-block').style.display = 'block';
                document.getElementById('print-mgr-name').textContent = data.manager.name;
                document.getElementById('print-mgr-phone').textContent = data.manager.phone;
                document.getElementById('print-mgr-email').textContent = data.manager.email;
            }

            // 2. Sections
            const container = document.getElementById('sections-container');
            data.sections.forEach(section => {
                const secDiv = document.createElement('div');
                secDiv.className = 'print-section';
                
                let rowsHtml = '';
                section.rows.forEach(row => {
                    let costHtml = '';
                    row.cost.forEach(c => costHtml += `<div class="price-badge">${c}</div>`);

                    if (row.type === 'fmc_merged') {
                        rowsHtml += `
                        <tr>
                            <td style="width:70%">
                                <div class="print-row-name">${row.name1} <span style="font-weight:400; color:#555;">(${row.val1})</span></div>
                                <div class="print-row-name" style="margin-top:6px;">${row.name2} <span style="font-weight:400; color:#555;">(${row.val2})</span></div>
                            </td>
                            <td style="width:30%"><div class="print-row-value">${costHtml}</div></td>
                        </tr>`;
                    } else if (row.type === 'region') {
                        rowsHtml += `
                        <tr>
                            <td style="width:70%">
                                <div class="print-row-name">${row.name}</div>
                                <div style="margin-top:4px; font-weight:400; color:#555; font-size:11px;">${row.val}</div>
                                ${row.desc ? `<div class="print-row-desc">${row.desc}</div>` : ''}
                            </td>
                            <td style="width:30%"><div class="print-row-value">${costHtml}</div></td>
                        </tr>`;
                    } else {
                         rowsHtml += `
                        <tr>
                            <td style="width:70%">
                                <div class="print-row-name">${row.name} <span style="font-weight:400; color:#555;">(${row.val})</span></div>
                                ${row.desc ? `<div class="print-row-desc">${row.desc}</div>` : ''}
                            </td>
                            <td style="width:30%"><div class="print-row-value">${costHtml}</div></td>
                        </tr>`;
                    }
                });

                secDiv.innerHTML = `
                    <div class="print-section-title" style="display:none">${section.title}</div>
                    <table class="print-table"><tbody>${rowsHtml}</tbody></table>
                `;
                container.appendChild(secDiv);
            });

            // 3. Totals
            document.getElementById('t-monthly').textContent = data.totals.monthly;
            
            const setTotal = (id, val, descId, desc) => {
                const row = document.getElementById('row-' + id.replace('t-', ''));
                if (!val || val.trim() === '0 ₽' || val.trim() === '0 ₽ / мес') {
                    row.style.display = 'none';
                } else {
                    document.getElementById(id).textContent = val;
                    document.getElementById(descId).innerHTML = desc;
                }
            };

            setTotal('t-minimal', data.totals.minimal, 't-minimal-desc', data.totals.minimalDesc);
            setTotal('t-connection', data.totals.connection, 't-connection-desc', data.totals.connectDesc);
            setTotal('t-delivery', data.totals.delivery, 't-delivery-desc', data.totals.deliveryDesc);
            setTotal('t-guarantee', data.totals.guarantee, 't-guarantee-desc', data.totals.guaranteeDesc);

            // 4. Generate PDF
            setTimeout(() => {
                const element = document.getElementById('print-area');
                const opt = {
                    margin:       5,
                    filename:     'KP_UIS.pdf',
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true, letterRendering: true, windowWidth: 800, scrollX: 0, scrollY: 0 },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak:    { mode: ['css', 'legacy'] }
                };
                
                html2pdf().set(opt).from(element).save().then(() => {
                    document.getElementById('loader').innerText = "PDF сформирован! Проверьте загрузки.";
                }).catch(err => {
                     document.getElementById('loader').innerText = "Ошибка сохранения: " + err.message;
                });
            }, 1000);

        } catch (e) {
            document.getElementById('loader').innerHTML = "Ошибка обработки данных.<br>" + e.message;
            console.error(e);
        }
    };
</script>

</body>
</html>